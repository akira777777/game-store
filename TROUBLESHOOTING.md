# Решение проблем с подключением к базе данных

## Ошибка P1000: Authentication failed

Эта ошибка означает, что Prisma не может аутентифицироваться в базе данных.

### Возможные причины

1. **Неверные учетные данные (username/password)**
2. **Пароль содержит специальные символы, которые нужно URL-кодировать**
3. **Пользователь не имеет доступа к базе данных**
4. **База данных недоступна из вашей сети**
5. **Проблемы с SSL/TLS соединением**

## Пошаговое решение

### Шаг 1: Проверьте учетные данные

1. Откройте панель управления вашего провайдера БД:
   - **Neon**: <https://console.neon.tech/>
   - **Supabase**: <https://supabase.com/dashboard>

2. Проверьте:
   - Имя пользователя (username)
   - Пароль (password)
   - Имя базы данных (database name)
   - Хост и порт

### Шаг 2: Сбросьте пароль (если нужно)

Если вы не уверены в пароле:

**Для Neon:**

1. Перейдите в **Settings** → **Users**
2. Найдите пользователя или создайте нового
3. Скопируйте новый пароль
4. Обновите `DATABASE_URL` в `.env`

**Для Supabase:**

1. Перейдите в **Settings** → **Database**
2. Найдите раздел **Database password**
3. Сбросьте пароль или используйте существующий
4. Обновите `DATABASE_URL` в `.env`

### Шаг 3: Проверьте URL-кодирование пароля

Если пароль содержит специальные символы, их нужно закодировать:

| Символ | Код |
|--------|-----|
| `@` | `%40` |
| `#` | `%23` |
| `$` | `%24` |
| `%` | `%25` |
| `&` | `%26` |
| `+` | `%2B` |
| `=` | `%3D` |
| `:` | `%3A` |
| `/` | `%2F` |
| `?` | `%3F` |

**Пример:**

- Пароль: `p@ss#word`
- В URL: `p%40ss%23word`

### Шаг 4: Используйте Connection String напрямую

Лучший способ - скопировать Connection String напрямую из панели управления провайдера:

**Neon:**

1. Откройте проект в Neon Console
2. Перейдите в **Connection Details**
3. Скопируйте **Connection string** (не Pooled connection)
4. Вставьте в `.env` файл

**Supabase:**

1. Откройте проект в Supabase Dashboard
2. Перейдите в **Settings** → **Database**
3. Найдите **Connection string** → **URI**
4. Скопируйте и вставьте в `.env`

### Шаг 5: Проверьте доступность базы данных

Убедитесь, что:

- База данных запущена и доступна
- Нет блокировок файрвола
- Для Neon: проверьте, что проект активен (не приостановлен)

### Шаг 6: Проверьте формат DATABASE_URL

Запустите скрипт проверки:

```powershell
.\scripts\check-db-url.ps1
```

Или расширенную проверку:

```powershell
.\scripts\fix-db-url.ps1
```

Или тест подключения:

```powershell
.\scripts\test-db-connection.ps1
```

### Шаг 7: Тест подключения через Prisma

Попробуйте выполнить простую команду Prisma:

```powershell
npx prisma db pull
```

Эта команда попытается подключиться к базе данных и покажет детальную ошибку, если подключение не удастся.

## Частые проблемы

### Проблема: Пароль содержит `@` символ

**Решение:** Закодируйте `@` как `%40`

**Пример:**

```
Неправильно: postgresql://user:p@ssword@host/db
Правильно:   postgresql://user:p%40ssword@host/db
```

### Проблема: Используется Pooled Connection для Neon

**Решение:** Используйте обычный Connection String, а не Pooled

Pooled connection имеет другой формат и может не работать с Prisma напрямую.

### Проблема: База данных приостановлена (Neon)

**Решение:**

1. Откройте Neon Console
2. Проверьте статус проекта
3. Если проект приостановлен, активируйте его

### Проблема: Неверный формат для Supabase

**Решение:** Убедитесь, что используете формат URI, а не JDBC или другой формат.

## Проверка после исправления

После обновления `DATABASE_URL`:

1. Проверьте формат:

   ```powershell
   .\scripts\check-db-url.ps1
   ```

2. Протестируйте подключение:

   ```powershell
   npx prisma db pull
   ```

3. Если подключение успешно, выполните миграции:

   ```powershell
   npx prisma migrate dev --name add_performance_indexes
   ```

## Получение помощи

Если проблема не решена:

1. Проверьте логи Prisma (они покажут детальную ошибку)
2. Проверьте документацию вашего провайдера БД
3. Убедитесь, что используете правильный Connection String из панели управления
