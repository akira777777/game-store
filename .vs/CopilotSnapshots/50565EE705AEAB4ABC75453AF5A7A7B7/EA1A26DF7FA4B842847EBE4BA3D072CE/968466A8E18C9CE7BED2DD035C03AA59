import { PaymentCardsList } from "@/components/payment-card/payment-cards-list"
import { PaymentCardFilters } from "@/components/payment-card/payment-card-filters"
import { PageHeader } from "@/components/layout/page-header"
import { db } from "@/lib/db"

export const dynamic = "force-dynamic"

interface SearchParams {
  cardType?: string
  region?: string
  search?: string
  page?: string
}

export default async function PaymentCardsPage({
  searchParams,
}: {
  searchParams: SearchParams
}) {
  try {
    const page = Math.max(1, parseInt(searchParams.page || "1", 10) || 1)
    const limit = 12
    const skip = (page - 1) * limit

    const whereConditions: Record<string, unknown> = {
      inStock: true,
    }

    if (searchParams.cardType?.trim()) {
      whereConditions.cardType = searchParams.cardType.trim()
    }

    if (searchParams.region?.trim()) {
      whereConditions.region = searchParams.region.trim()
    }

    if (searchParams.search?.trim()) {
      const databaseUrl = process.env.DATABASE_URL?.trim() || ''
      const isSQLite = databaseUrl.startsWith('file:')
      const searchTerm = searchParams.search.trim()
      const searchCondition = isSQLite
        ? { contains: searchTerm }
        : { contains: searchTerm, mode: 'insensitive' as const }
      
      whereConditions.OR = [
        {
          title: searchCondition,
        },
        {
          description: searchCondition,
        },
      ]
    }

    const [cards, total] = await Promise.all([
      db.paymentCard.findMany({
        where: whereConditions,
        orderBy: { createdAt: "desc" },
        skip,
        take: limit,
      }),
      db.paymentCard.count({
        where: whereConditions,
      }),
    ])

    // Get unique card types and regions for filters
    const allCards = await db.paymentCard.findMany({
      where: { inStock: true },
      select: { cardType: true, region: true },
    })
    const cardTypes = Array.from(new Set(allCards.map(c => c.cardType).filter(Boolean))) as string[]
    const regions = Array.from(new Set(allCards.map(c => c.region).filter(Boolean))) as string[]

    return (
      <main className="container mx-auto px-4 py-8 max-w-6xl space-y-6" role="main">
        <PageHeader
          title="Платежные карты"
          description="Покупайте платежные карты различных типов и регионов"
          backUrl="/"
        />

        {/* Filters */}
        <PaymentCardFilters
          cardTypes={cardTypes}
          regions={regions}
          currentCardType={searchParams.cardType}
          currentRegion={searchParams.region}
        />

        <PaymentCardsList cards={cards} total={total} />

        {/* Pagination */}
        {total > limit && (
          <div className="mt-10 flex flex-wrap items-center justify-center gap-3 rounded-lg border bg-muted/30 px-4 py-3 text-sm">
            {page > 1 && (
              <a
                href={`?${new URLSearchParams({
                  ...searchParams,
                  page: String(page - 1),
                }).toString()}`}
                className="px-4 py-2 border rounded-md hover:bg-accent bg-background shadow-sm"
              >
                Назад
              </a>
            )}
            <span className="px-4 py-2">
              Страница {page} из {Math.ceil(total / limit)}
            </span>
            {page < Math.ceil(total / limit) && (
              <a
                href={`?${new URLSearchParams({
                  ...searchParams,
                  page: String(page + 1),
                }).toString()}`}
                className="px-4 py-2 border rounded-md hover:bg-accent bg-background shadow-sm"
              >
                Вперед
              </a>
            )}
          </div>
        )}
      </main>
    )
  } catch (error) {
    console.error("Error fetching payment cards:", error)
    return (
      <main className="container mx-auto px-4 py-8">
        <PageHeader title="Платежные карты" backUrl="/" />
        <div className="text-center py-12">
          <p className="text-destructive">Ошибка при загрузке карт</p>
        </div>
      </main>
    )
  }
}
