import { defineConfig } from "prisma/config";

// Load environment variables from .env.local or .env
let databaseUrl = process.env.DATABASE_URL;

if (!databaseUrl) {
  // Try to use a default local SQLite path if DATABASE_URL is not set
  if (process.env.NODE_ENV !== 'production') {
    databaseUrl = 'file:./prisma/dev.db';
  } else {
    throw new Error('DATABASE_URL environment variable must be set in production');
  }
}

// Determine database type
const isPostgreSQL = /^postgres(ql)?:\/\/.+/.test(databaseUrl);
const isSQLite = /^file:/.test(databaseUrl);

// Validate DATABASE_URL format
if (!isPostgreSQL && !isSQLite) {
  const errorMessage =
    "Invalid DATABASE_URL format. Please provide a valid connection string.\n" +
    "PostgreSQL format: postgresql://user:password@host:port/database?sslmode=require\n" +
    "SQLite format: file:./prisma/dev.db\n" +
    `Got: ${databaseUrl.substring(0, 50)}...`;
  throw new Error(errorMessage);
}

// Check if using pooled connection (Neon pooler) - only for PostgreSQL
const isPooledConnection = isPostgreSQL && databaseUrl.includes('pooler');
let directUrl: string | undefined;

if (isPooledConnection) {
  // For pooled connections, migrations need directUrl (non-pooled)
  try {
    const url = new URL(databaseUrl);
    let hostname = url.hostname;

    // Remove '-pooler' from hostname (e.g., 'ep-xxx-pooler' -> 'ep-xxx')
    hostname = hostname.replace(/-pooler(?=\.|$)/, '');

    // Replace '.c-' with '.' for Neon URLs
    if (hostname.includes('.c-neon.') || (hostname.includes('.c-') && hostname.includes('neon'))) {
      hostname = hostname.replace(/\.c-(?=neon\.)/, '.');
    }

    // Reconstruct URL with modified hostname
    url.hostname = hostname;
    directUrl = url.toString();
  } catch (error) {
    // Fallback: simple string replacement
    const atIndex = databaseUrl.indexOf('@');
    const slashIndex = databaseUrl.indexOf('/', atIndex);
    if (atIndex !== -1) {
      const beforeHost = databaseUrl.substring(0, atIndex + 1);
      const hostPart = slashIndex !== -1
        ? databaseUrl.substring(atIndex + 1, slashIndex)
        : databaseUrl.substring(atIndex + 1);
      const afterHost = slashIndex !== -1
        ? databaseUrl.substring(slashIndex)
        : '';

      let modifiedHost = hostPart.replace(/-pooler(?=\.|$)/, '');
      if (modifiedHost.includes('.c-neon.') || (modifiedHost.includes('.c-') && modifiedHost.includes('neon'))) {
        modifiedHost = modifiedHost.replace(/\.c-(?=neon\.)/, '.');
      }

      directUrl = beforeHost + modifiedHost + afterHost;
    } else {
      directUrl = databaseUrl.replace(/-pooler(?=\.|$)/, '').replace(/\.c-(?=neon\.)/, '.');
    }
  }
}

const config = defineConfig({
  schema: "prisma/schema.prisma",
  migrations: { path: "prisma/migrations" },
  datasource: {
    url: databaseUrl,
    // For Neon pooled PostgreSQL connections, migrations need directUrl
    ...(isPostgreSQL && directUrl && { directUrl }),
  },
});

export default config;
